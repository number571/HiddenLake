package anon

import (
	"context"
	"net"
	"testing"
	"time"

	"github.com/number571/go-peer/pkg/crypto/asymmetric"
	"github.com/number571/go-peer/pkg/encoding"
	"github.com/number571/go-peer/pkg/logger"
	anon_logger "github.com/number571/go-peer/pkg/network/anonymity/logger"
	"github.com/number571/go-peer/pkg/network/conn"
	net_message "github.com/number571/go-peer/pkg/network/message"
)

var (
	_ conn.IConn = &tsConn{}
	_ net.Conn   = &tsNetConn{}
	_ net.Addr   = &tsAddr{}
)

type tsConn struct{}

func (p *tsConn) Close() error                                             { return nil }
func (p *tsConn) GetSettings() conn.ISettings                              { return nil }
func (p *tsConn) GetSocket() net.Conn                                      { return &tsNetConn{} }
func (p *tsConn) WriteMessage(context.Context, net_message.IMessage) error { return nil }
func (p *tsConn) ReadMessage(context.Context, chan<- struct{}) (net_message.IMessage, error) {
	return nil, nil
}

type tsNetConn struct{}

func (p *tsNetConn) Read(_ []byte) (n int, err error)   { return 0, nil }
func (p *tsNetConn) Write(_ []byte) (n int, err error)  { return 0, nil }
func (p *tsNetConn) Close() error                       { return nil }
func (p *tsNetConn) LocalAddr() net.Addr                { return &tsAddr{} }
func (p *tsNetConn) RemoteAddr() net.Addr               { return &tsAddr{} }
func (p *tsNetConn) SetDeadline(_ time.Time) error      { return nil }
func (p *tsNetConn) SetReadDeadline(_ time.Time) error  { return nil }
func (p *tsNetConn) SetWriteDeadline(_ time.Time) error { return nil }

type tsAddr struct{}

func (p *tsAddr) Network() string { return "tcp" }
func (p *tsAddr) String() string  { return "192.168.0.1:2000" }

const (
	tcService = "TST"
	tcHash    = "96cb1f0968adba001ebc216708a02c8d2817b1a77fad1206012c22716a9b130b"
	tcFmtLog  = "service=TST type=ENQRQ hash=96CB1F09...00000000 addr=92D185C4...A9BCDC7F proof=0000012345 size=1024B conn=192.168.0.1:2000"
)

func TestLoggerPanic(t *testing.T) {
	t.Parallel()

	logFunc := GetLogFunc()
	for i := 0; i < 3; i++ {
		testLoggerPanic(t, logFunc, i)
	}
}

func testLoggerPanic(t *testing.T, f logger.ILogFunc, n int) {
	defer func() {
		if r := recover(); r == nil {
			t.Error("nothing panics")
			return
		}
	}()
	switch n {
	case 0:
		f(struct{}{})
	case 1:
		logger := testNewAnonLogger()
		f(logger) // without type
	case 2:
		logger := testNewAnonLogger().WithType(255)
		f(logger) // with unknown type
	}
}

func TestLogger(t *testing.T) {
	t.Parallel()

	logger := testNewAnonLogger().
		WithType(anon_logger.CLogBaseEnqueueRequest)

	logFunc := GetLogFunc()
	if l := logFunc(logger); l != tcFmtLog {
		t.Error("result fmtLog != tcFmtLog")
		return
	}
}

func testNewAnonLogger() anon_logger.ILogBuilder {
	privKey := asymmetric.LoadPubKeyChain(tgPubKey)
	return anon_logger.NewLogBuilder(tcService).
		WithHash(encoding.HexDecode(tcHash)).
		WithProof(12345).
		WithSize(1024).
		WithPubKey(privKey.GetSignPubKey()).
		WithConn(&tsConn{})
}

const (
	tgPubKey = `PubKey{2A8A77E48CCF58360C85D37CFA7145244B292DA134ED4403AA7C4F95E82C91793C44E3B39822B4AF9604B1C96F1C237E6E492B3BA7B1F7E522FA430AFF39932EF543258B22C80911D61A6B85CBCF54A42A70EB7A6C8C5B7FD643974AADD0B83852253149B0670AE663A13A06AE0039FDEB4DB4845B32F143CF291BD5219A6D5B2C5D105E08ABC17AD134F939A104C2665F060661193398C89B7C591EF6394C57B7A0ED47935BA1BC75E6AFB37921E7D50A0BB89A2B90BE0CB588183666073475327A2913A27317D776037BA146FA5981A43C56771AF39886B36990DBCB13717B3256025CEE974BB7692241B74476370622E0C960910118B1BA9D5695ADD6097AF197E7D5C09B32CD88C15BB37C6852B83D103AA1BAA35C8EE0A54FCB9FE8E019C4D79F5602C755F528A110BE42E9104D793B2F296864B09BEF033C4818B459494344B695E32132FEB6530D3A659F4A3AFE8476EF82609EB2687887CCC761BC85088124C1373727AA87048895CB1621C5BBCC690E013CC330A3328B8685F2B38939D09D8A953A1AF120E93523F8A25AD08BC99074C9E7FA7F15421504FA764FE234B00513739C597F3C10A724CE9CC39677404C240B47D7A90CCA38469491A9C181137D9C4C5B11413DEA97CA0616A67B3E9249BA974543DCFC6987621AD09248C589A04B88941B1B96FD1A3D54B718E879A88FEC31BF595E8570583A41093D5772559449E66A4B039113C72C2EF0B5820AEC2FAF23646A7074819CCE56C770EA57CC31029181B7151B549324D14A0E2B974EE22377E57EAE52999E90714FB6BC9B8731380CACD439BE01D24C5AB11EB2A2174A1C790F5234C0BBC9647597A41677E7411225375622A32ADD865C5C29B6F82ABBF92C934016C063B589CE12279AB819AF1ACF633370CD8935EE9224951A8CA0A3B6A41054EE74459511053819421AEB155AE7242C21110E1278A3A2A052361F6FA0B561EB0DA68B69B8595FAC8646B1618361F9398C815F6A28308F9853EE785AC7202A1FC93ACFC42BD5C56677413964FCB76FF5432074BCE3861852F8840C997E69042D8AB43B43D48CA9846D11354675536769C0ADA4F63CD0040A386A8EBC895D69D175402C0AA5A7C30EAB331DA85983A0A513DA175CA369CBD24D5D90463406AC17FA034CFC945F5C3821D16426EA37E8F7BABCC93DF4FC2106C98A07B67EF2DABD7963AEB77866D9D53FDA688D0D98C4701065AB9BC58A375871642A9237A15291A834EA11141A68C21C897E511D2FF76167D9B756671BEC19B5C024CA49CB44C8B119F7187AB5F7AEBF179DF8C60E57B3CAF72085797509646B96A6E0130B6A81675586D70287821BB07B4C470815263177033CA388ED579BA80CCAF135B24212C29D619E84F5383B06A8CB11807C775C1CC4098A73CA579503C357356A4B8888D6250EB4280D307F8E5C02A7C2222920C8175285C40348276BC046815D00A89BB459AC33C66C5E7CA5624AC1DC1AC7BFBB10C8938EA2245508E22104D10ACF69B4CE635549D9915D1B79781A4059A4773BA96CEB18507772262FEA2E68FB8A73DA8DF95A9B2FF4270358342AA2737504517F77C17C89A2E8594DE2C89AC79C205FEA46EF6411DE8AC364EA01D39AECA58BB58D8802116C3CB036E8532629587375441B3174260D53D5;1C1CDBF2F372603E409325F36BCCBC52038A330AC03B57A9563BF13E3DC611C720C0C4D8AE85F48E5160B0EF078980D8D7E100EDAAA83A4C869C8114C539BFCB1F74632C629181B6559812290662AC4124EB341B983AB3B69EFCA68CE939A63CCEAB135812173554CADC91A21A8ED98C2B0BA225288D5A7B1ADD517C69ED7FB2D9EA52159A045BB5811F69E1904C776771CC2487781686D369340586AAA8D2EC9871F91E295514CBFC0753B37C904A8E37EEF89F2CBC1B2A36EEE8B22AA8BEF236D684B8A9F9B5A6563D3269DD53AF7F58172EEF4210EA32CA7EAC4E0CB70984EF584CFC3982A2B5D27737FE7D8AC9E5802EF20782B1CA203C77F639BE7CFE0DF221C82158FEBFB56D1A55642CBEF030F0EDAADEF5A10BDCC48C7C9B11F291FE1DB2710F21C57D952DCED6C2A786ED0AD9F1161B603C95CD9ED3B03C031773E47023BE77790E602E60FAB8B0DB84A910DDA85099848D5D275CF7C2E3BA984176810D73F71F62F4369F8095C1EA240AA86E5910AD17F7630FA4B98B89A75D48FF16183F964EC8BBBF5DC60DB6651DC373EB6DEB80F3EBDCE11AE3B799D443CDD621D0FA3A013B6B49556906B99F7AD945E2A95E44A4E0E6DE9929491FD4F9D4EE20CF81B6E69F49CC1CF5A34CD11E6300CA79E831241102A5B4AC687D94A64189CB648B246AE72F9692FC724B2D46D8894D833D5DD89D411F5EF39AE46DF7DAB60FD21C253473529B9E179FC0831CD30F61EA3D31420A0EBDD622894A4EB3346FF0EFF41DD6023683F53A072B5E4D139F0BE94CFA7BA67047A4344664BEE2DDE2F5F6E00A55CE75231065012A024A1846A1F6963F9BAD57FAB0F79CE696244998820158993FCE6E3431A8F7EC4CA2A3CB01604E7395A4A3635BA93A6E2076C899537A9959813D198E8D1BE358EDFABFFFD316D295870695392E03C69668E4DF3FAA6D03FDECE0FCDA4ADBE564802B91C9D685B407437BFA31546CC50C696D93DC08709DB077F288C3FCA9499D7EDA258DBB36B031D83864F962DE46D0C742C4E3B9817485693B8DF2846B5AE880822154253D9B5EDC126CC4BFCBEC6D9E7C3E0C9A9AAF11C508C51DE9DD64BE8446A14E7DE7C87CFB7F3212AC51557C28D0583A85EF14D5495BD0CE5D78A86287106323B42FF93A6BF525736BD0C353527F2644FECE7CEA01CFA5ECA6E8EB811560A8B505E533E7E2CDD4E7550827B5DC78209DA2BE3CEFC92CA8E34BED42A206C15C010FDCC22CA5F7AD45CB6FD68D9144D8FE805E6E03A52AEF32ABAC194C239E27EC86058DDE63C1E2CBDCE56A4A697D02ACC47C7B4F4F54690DEAC69BBA16B6E9B0E91003CA85073446608C7452355A1DCB5281B11B21737D37D3DE7F2DD0BAB0E19D31B6C0788E7AB9E94526457C9FE02848C055CEC0257D329312AB42EE9527124F1689CA6D914D80F10DBCF5098D10A7F729128621940267366072D8262F1FDF78CBF5B1E9A1F85B412E2847D92197857F8AEE585600AA1466079FBDDB6E695DCCC3184DCD70AA44FBC09F494C9779558F005DC9E2E594A7C3C64AD67A712B30D4DD6D713D037210DACADD3593969121AC4FE0FBC509538142CC6B8C2221431757A1AFA1A44144037A01EFF55D23331A801C05C29BB301D25E633052154CF8D74CCCD473FEC89D4AD5B6A062CF89FA8C9F9CA931B51DFEDF928B8AD381473EFA423D006B4B393369333C418CC95F672EED63A2CCD534FC6D84E1A7C6B690C55F431CAED7B14EC740A0B0382A7E945B9C2A60B52116AAC7A3A0CEE512619F16AFDF1DAF1FEC50A763929EC11C6BA453C768EAB91A6E4F6EE59A67C08341459F26588037329E2F068E835F5784E47EEC1E87B5E65BF2A1C8D20FDB6009C71F44E09585A5A215AAD5187BB002AF13FCFE3E1424A38AFACDE65F3D4FB53F12D2121564E4E593876B1810BCF727DE99B1FD811648922FD37D0FE784BEB18AE7E1B68D6BF98BD07A698F31445FFD9B3D406D75F30E3213C5C470C3FC6A32B3E9E5A4CAD2DB63608CB61FC5724BFC582CD5989CB51ADE30A72C93640E53E2C8DE5A7D00567C71D145857CFB96FDFC46FC3987C5B8FBAAB9819D45DA416630CC7C1AF94C7537C4496F0C09E79CAF77027FE69E4CFA4A60006F096C099E208988AD60940E8FAC862AFB772DB3F2DA2B1FA92D7ADD12780F6AEAAC03801B3DA0EC08788A00B3E162B5A2CBD94922B5FC4866A3F98FE45EBA995AE874E0948C4F7DF358A2B55F36FD521D0D83EDC81F2792A04383650FE22C1185F23EFB9EFE977FCA0A60E925D5C70B45547E42FFA9ECA061406E44C9975C42093CE8385A6F7B80B93CAE482BFE60591C5244CC0E1AD892B8EBE82DBFBD0490D09810E3F1A14EB8895D3065D32D85DF327F04DD4925D49DF9B2F9FAB9F8D73C88837763FEA763BBED25723F5BCB4046D64FE5A6969B2F1D42A423216083C76B84E8AC853AEA76324CE6A165B449F7715F43660C2A06DF43F5CD59F593D9A07524B0782C703A812E8829C3BCD4941C2C97A9ECA606E92DC6262B33C6BEF130D07CACDD648BC3A53BA4F2F2A42EAE7F6DC42BFD440D2D8C5D54226004256D511FB23C5593E2C7AF7FFBA66B53E3E9DDA7282B28999C9760A8FA5921DF1471E57C63B9C6CB7834F520980D56055DC2D98E0AEE3B752D722B4D9181C93F3C2126A6AE3391D2D3C09E909C61BC648C57A6EBF15E6C74B47A9A15B47DEB96A29B6844711B051EF3B9278214E1DE6B522A5DC4CEBF3884495B66CF221DCB22}`
)
